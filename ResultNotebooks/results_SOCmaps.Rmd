---
title: "Global SOC maps and emissions"
output:
  md_document:
    variant: markdown_github
---

```{r load}
library(mrcommons)
library(mrvalidation)
library(mrSOCbudget)
library(magpiesets)

rev <- "rev0.6_mrSOC"

setConfig(cachefolder  = paste0("/home/kristine/mnt/rd3mod/inputdata/cache/", rev), forcecache = TRUE)
setConfig(sourcefolder = "/home/kristine/mnt/rd3mod/inputdata/sources/")
setConfig(outputfolder = "/home/kristine/mnt/rd3mod/inputdata/output/")
untar(paste0(getConfig("outputfolder"),"/",rev, "_h12_carbonbudget.tgz"), exdir="Data", extras="--keep-newer-files ")

SoilCarbon <- read.magpie("Data/SoilCarbon.rds")
Landuse    <- read.magpie("Data/Landuse.rds")

```

Calc global numbers

```{r Carbon Emissions (glo)}

SoilCarbon[,,"naturalstate.crop"] <- SoilCarbon[,,"naturalstate.natveg"]
SOCStock        <- dimSums(dimSums(SoilCarbon[,,"state",pmatch=TRUE], dim=3.3)* Landuse, dim=3.2)
glo_SOCStock    <- dimSums(SOCStock, dim=1) 
glo_SOCEmission <- glo_SOCStock[,,"naturalstate"] - glo_SOCStock[,,"actualstate"]  
plot(getYears(glo_SOCEmission, as.integer = TRUE),glo_SOCEmission/1000, type="l", xlab="Time", ylab="Global SOC Debt in GtC")
plot(getYears(glo_SOCEmission, as.integer = TRUE),glo_SOCStock[,,"actualstate"])
lines(getYears(glo_SOCEmission, as.integer = TRUE),glo_SOCStock[,,"naturalstate"])
```


Plot cellular maps




```{r plot density maps}


cropland_dens    <- dimSums(SoilCarbon[,,"actualstate"][,,"crop"], dim=3)
cropland_dens[cropland_dens==0] <- NA

cropland_share <- dimSums(SoilCarbon[,,"actualstate"][,,"crop"], dim=3)/dimSums(SoilCarbon[,,"naturalstate"][,,"natveg"], dim=3)
cropland_share[Landuse[,,"crop"]==0] <- NA

cropland_increase <- dimSums(SoilCarbon[,,"actualstate"][,,"crop"], dim=3)-dimSums(SoilCarbon[,,"actualstate"][,,"natveg"], dim=3) 
cropland_increase[Landuse[,,"crop"]==0] <- NA

library(RColorBrewer)
cols      <- colorRampPalette(brewer.pal(11, "RdYlGn"))(7)
cols_dens <- colorRampPalette(brewer.pal(11, "RdYlGn"))(30)[c(1:20, rep(c(21:30), each=10))]
outputdir <- "Output/Images"


png(paste0(outputdir,"CDens_2010.png"), width = 1280, height = 720, res = 108)
luplot::plotmap(cropland_dens[,"y2010",], legend_range = c(0,300), legend_colours = cols_dens , main="Soil Organic Carbon Stocks under Cropland")
dev.off()

# png(paste0(outputdir,"CShare_1965.png"),width = 1280, height = 720, res = 108)
# luplot::plotmap(cropland_share[,"y1965",], legend_range = c(0,2), legend_colours = cols, main="C_share on Cropland 1965")
# dev.off()

png(paste0(outputdir,"CShare_2010.png"), width = 1280, height = 720, res = 108)
luplot::plotmap(cropland_share[,"y2010",], legend_range = c(0,2), legend_colours = cols, main="Stock Change Factor on Cropland 2010")
dev.off()

# png(paste0(outputdir,"CIncrease_1965.png"),width = 1280, height = 720, res = 108)
# luplot::plotmap(cropland_increase[,"y1965",], legend_range = c(-80,80), legend_colours = cols, main="Absoulte C change on Cropland 1965")
# dev.off()

png(paste0(outputdir,"CIncrease_2010.png"),width = 1280, height = 720, res = 108)
luplot::plotmap(cropland_increase[,"y2010",], legend_range = c(-80,80), legend_colours = cols, legend_title = "tC/ha", main="Absoulte C change on Cropland 2010")
dev.off()


```



```{r grid plot}
library(gridExtra)

par(mfrow = c(2, 2))

luplot::plotmap(cropland_dens[,"y2010",], legend_range = c(0,300), legend_colours = cols_dens , 
                main="SOC Stocks under Cropland")
plot(getYears(glo_SOCEmission, as.integer = TRUE),glo_SOCEmission/1000, type="l", xlab="Time",
     ylab="Global SOC Debt in GtC")
luplot::plotmap(cropland_share[,"y2010",], legend_range = c(0,2), legend_colours = cols)
luplot::plotmap(cropland_increase[,"y2010",], legend_range = c(-80,80), legend_colours = cols,
                legend_title = "tC/ha")


```




```{r plot diff maps, out.width="100%", out.height=1000}

library(luplot)
library(magpiesets)


cellSOCdens   <- (dimSums(dimSums(SoilCarbon[,,"naturalstate"], dim=3.2) * Landuse, dim=c(3))/dimSums(Landuse, dim=c(3)))[,findset("past"),]
cellSOCdens[is.na(cellSOCdens)] <- 0

cellSoilGrids <- readSource("SoilGrids", subtype="cstock_0_30", convert="onlycorrect")
cellLPJml     <- calcOutput("LPJmL", version="LPJmL4", climatetype="CRU_4", subtype="soilc_layer", time="raw", selectyears="past", aggregate=FALSE)
cellLPJml     <- collapseNames(cellLPJml[,,"layer1"]+1/3*cellLPJml[,,"layer2"], collapsedim = c(2,3))



diffSoilGrids <- cellSOCdens - cellSoilGrids
diffLPJml     <- cellSOCdens - cellLPJml

luplot::plotmap(diffLPJml[,10,], legend_range = c(-80,80))
```








```{r plot density maps 2}


cols <- colorRampPalette(brewer.pal(9,"Oranges"))(1000)
cropland <- dimSums(SoilCarbon[,,"crop"], dim=3)
cropland[Landuse[,,"crop"]==0] <- NA

luplot::plotmap(cropland[,"y2010",], legend_colours = cols, legend_range=range(cropland[,"y2010",]/5, na.rm=TRUE))

natland <- dimSums(SoilCarbon[,,"natveg"], dim=3)

luplot::plotmap(natland[,"y2010",], legend_colours = cols, legend_range=range(cropland[,"y2010",]/5, na.rm=TRUE))

```